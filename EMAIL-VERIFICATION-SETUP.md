# Настройка системы подтверждения Email

## Обзор

Реализована система подтверждения email при регистрации пользователей. Система включает:

1. **Генерация 6-значного кода** при регистрации
2. **Отправка красивого email** с кодом подтверждения
3. **Страница подтверждения** с 6 квадратами для ввода кода
4. **Проверка подтверждения** при входе в систему
5. **Повторная отправка кода** при необходимости

## Настройка Email сервиса

### Данные для подключения:
- **SMTP сервер**: `mail.стримкэш.рф`
- **Порт**: `587`
- **Email**: `no-reply@стрикэш.рф`
- **Пароль**: `UfjuQqDoCk`
- **TLS**: Включен

### Переменные окружения

В `docker-compose.ssl.yml` уже добавлены настройки:

```yaml
environment:
  - EMAIL_HOST=mail.стримкэш.рф
  - EMAIL_PORT=587
  - EMAIL_HOST_USER=no-reply@стрикэш.рф
  - EMAIL_HOST_PASSWORD=UfjuQqDoCk
  - EMAIL_USE_TLS=true
```

## Изменения в базе данных

### Новые поля в таблице `users`:

```sql
ALTER TABLE users ADD COLUMN email_verified BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN email_verification_code VARCHAR;
ALTER TABLE users ADD COLUMN email_verification_expires TIMESTAMP;
```

### Миграция

Создана миграция `008_add_email_verification_fields.py` для автоматического добавления полей.

## API Endpoints

### Новые endpoints:

1. **POST /api/v1/auth/verify-email**
   - Подтверждение email с кодом
   - Body: `{ "email": "user@example.com", "code": "123456" }`

2. **POST /api/v1/auth/resend-verification**
   - Повторная отправка кода подтверждения
   - Body: `{ "email": "user@example.com" }`

### Обновленные endpoints:

1. **POST /api/v1/auth/register**
   - Теперь отправляет код подтверждения после регистрации
   - Возвращает пользователя без токена

2. **POST /api/v1/auth/login**
   - Проверяет подтверждение email
   - Если email не подтвержден, отправляет новый код и возвращает ошибку

## Фронтенд

### Новые страницы:

1. **`/verify-email`** - страница подтверждения email
   - 6 квадратов для ввода кода
   - Автоматический переход между полями
   - Поддержка вставки кода
   - Кнопка повторной отправки

### Обновленные страницы:

1. **`/register`** - перенаправляет на `/verify-email` после регистрации
2. **`/login`** - перенаправляет на `/verify-email` если email не подтвержден

## Процесс регистрации

1. **Регистрация** → Пользователь заполняет форму
2. **Создание аккаунта** → Пользователь создается с `email_verified = false`
3. **Генерация кода** → Создается 6-значный код с истечением через 10 минут
4. **Отправка email** → Красивое письмо с кодом отправляется на email
5. **Перенаправление** → Пользователь попадает на страницу подтверждения
6. **Ввод кода** → Пользователь вводит 6-значный код
7. **Подтверждение** → Email помечается как подтвержденный
8. **Вход** → Пользователь может войти в систему

## Процесс входа

1. **Попытка входа** → Пользователь вводит логин/пароль
2. **Проверка email** → Система проверяет `email_verified`
3. **Если не подтвержден** → Отправляется новый код и перенаправление на `/verify-email`
4. **Если подтвержден** → Успешный вход в систему

## Безопасность

- Код действителен **10 минут**
- Код генерируется из **цифр 0-9**
- После подтверждения код **удаляется** из базы
- **TLS шифрование** для отправки email
- **Защита от брутфорса** - код меняется при каждой попытке

## Тестирование

### Локальное тестирование:

1. Запустите MailHog для перехвата email:
   ```bash
   docker-compose -f docker-compose.ssl.yml --profile dev up mailhog
   ```

2. Откройте MailHog UI: `http://localhost:8025`

3. Зарегистрируйте пользователя и проверьте получение email

### Продакшн тестирование:

1. Убедитесь, что почтовый сервер настроен
2. Зарегистрируйте тестового пользователя
3. Проверьте получение email с кодом
4. Подтвердите email и войдите в систему

## Устранение неполадок

### Email не отправляется:

1. Проверьте настройки SMTP в конфигурации
2. Убедитесь, что почтовый сервер доступен
3. Проверьте логи API Gateway

### Код не принимается:

1. Проверьте время истечения кода (10 минут)
2. Убедитесь, что код введен правильно
3. Проверьте логи базы данных

### Пользователь не может войти:

1. Проверьте статус `email_verified` в базе данных
2. Убедитесь, что email подтвержден
3. Попробуйте повторную отправку кода

## Дополнительные возможности

- **Красивый email шаблон** с градиентами и иконками
- **Адаптивный дизайн** страницы подтверждения
- **Автоматический фокус** на следующее поле при вводе
- **Поддержка вставки** кода из буфера обмена
- **Анимации и переходы** для лучшего UX
- **Обработка ошибок** с понятными сообщениями 