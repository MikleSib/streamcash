# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π

## –ü—Ä–æ–±–ª–µ–º–∞
Webhook'–∏ –æ—Ç T-Bank –º–æ–≥—É—Ç –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç—å –∏–ª–∏ —Ç–µ—Ä—è—Ç—å—Å—è, –∏–∑-–∑–∞ —á–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ PENDING –¥–∞–∂–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.

## –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ PENDING –ø–ª–∞—Ç–µ–∂–µ–π –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ —á–µ—Ä–µ–∑ Celery.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### 1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Redis –∑–∞–ø—É—â–µ–Ω
```bash
# Windows
redis-server

# Linux/Mac
sudo systemctl start redis
# –∏–ª–∏
redis-server
```

### 2. –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ (Windows):
```bash
cd backend
start_celery.bat
```

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ (Linux/Mac):
```bash
cd backend
chmod +x start_celery.sh
./start_celery.sh
```

#### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫:
```bash
cd backend

# Terminal 1: Celery Worker
python start_celery_worker.py

# Terminal 2: Celery Beat (–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫)
python start_celery_beat.py
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

#### –ß–µ—Ä–µ–∑ API:
```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å PENDING –ø–ª–∞—Ç–µ–∂–∏
curl http://localhost:8000/api/v1/payments/pending-payments

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä—É—á–Ω—É—é
curl -X POST http://localhost:8000/api/v1/payments/check-pending

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞—Ç–µ–∂
curl http://localhost:8000/api/v1/payments/tbank/check/ORDER_ID
```

#### –ß–µ—Ä–µ–∑ –ª–æ–≥–∏:
–í –∫–æ–Ω—Å–æ–ª–∏ Celery Worker –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –ª–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:
```
üîç –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ PENDING –ø–ª–∞—Ç–µ–∂–µ–π
üìä –ù–∞–π–¥–µ–Ω–æ X PENDING –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: X, –û–±–Ω–æ–≤–ª–µ–Ω–æ: Y
```

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **Celery Beat** –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∑–∞–¥–∞—á—É `check_pending_payments`
2. **Celery Worker** –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á—É:
   - –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ PENDING –ø–ª–∞—Ç–µ–∂–∏ T-Bank —Å payment_id
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑—ã–≤–∞–µ—Ç T-Bank API GetState
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –µ—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ –∑–∞–≤–µ—Ä—à–µ–Ω
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—Ç—Ä–∏–º–µ—Ä–∞

3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**:
   - CONFIRMED/AUTHORIZED ‚Üí COMPLETED
   - CANCELLED/REVERSED/REFUNDED ‚Üí FAILED

## –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞—Ç–µ–∂ —Å—Ä–∞–∑—É:

```python
# –í –∫–æ–¥–µ
from app.worker import check_pending_payments
result = check_pending_payments()
```

```bash
# –ß–µ—Ä–µ–∑ API
curl -X POST http://localhost:8000/api/v1/payments/check-pending
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
- –°–∫–æ–ª—å–∫–æ –ø–ª–∞—Ç–µ–∂–µ–π –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ
- –°–∫–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
- –û—à–∏–±–∫–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

## –û—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Celery
pkill -f celery

# –ò–ª–∏ –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ —Å Worker –∏ Beat
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–∞—Å—Ç–æ—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

–í —Ñ–∞–π–ª–µ `backend/app/celery_app.py` –∏–∑–º–µ–Ω–∏—Ç–µ:
```python
celery_app.conf.beat_schedule = {
    "check-pending-payments": {
        "task": "app.worker.check_pending_payments",
        "schedule": 10.0,  # —Å–µ–∫—É–Ω–¥—ã (10 = –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥)
    },
}
```

## Troubleshooting

### Redis –Ω–µ –∑–∞–ø—É—â–µ–Ω
```
–û—à–∏–±–∫–∞: Redis connection failed
–†–µ—à–µ–Ω–∏–µ: –ó–∞–ø—É—Å—Ç–∏—Ç—å redis-server
```

### Celery worker –Ω–µ –≤–∏–¥–∏—Ç –∑–∞–¥–∞—á–∏
```
–†–µ—à–µ–Ω–∏–µ: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å worker –∏ beat –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
```

### –ó–∞–¥–∞—á–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è
```
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ worker'–∞ –Ω–∞ –æ—à–∏–±–∫–∏
–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ beat –∑–∞–ø—É—â–µ–Ω
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
```